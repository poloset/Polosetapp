name: EAS Build (Android + iOS) and download artifacts

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: 18

concurrency:
  group: eas-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build & download Android + iOS (EAS)
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      APPLE_API_KEY_P8_BASE64: ${{ secrets.APPLE_API_KEY_P8_BASE64 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: mobile
        run: npm ci

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Verify Expo token is present
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${EXPO_TOKEN:-}" ]; then
            echo "ERROR: Missing EXPO_TOKEN secret. Add it in GitHub: Settings → Secrets and variables → Actions."
            exit 2
          fi

      # Optional: provide App Store Connect API Key .p8 for future `eas submit` usage
      # Store the *base64* of the downloaded .p8 as GitHub secret APPLE_API_KEY_P8_BASE64.
      - name: Write App Store Connect API key file (optional)
        working-directory: mobile
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${APPLE_API_KEY_P8_BASE64:-}" ]; then
            echo "APPLE_API_KEY_P8_BASE64 not set; skipping asc-api-key.p8 creation."
            exit 0
          fi
          printf '%s' "$APPLE_API_KEY_P8_BASE64" | base64 --decode > asc-api-key.p8
          chmod 600 asc-api-key.p8

      - name: Run EAS build (Android + iOS production) and save JSON
        id: builds
        shell: bash
        run: |
          set -euo pipefail
          # Run builds and emit machine-readable JSON to file
          cd mobile
          # Note: keep stdout as JSON, but capture stderr for real failure reasons.
          eas whoami || true
          eas build --platform all --profile production --non-interactive --json --wait --verbose-logs --build-logger-level debug \
            > ../builds.json 2> ../eas_build_stderr.log
          cd ..

          # If EAS printed non-JSON output to stderr, include it in logs.
          if [ -s eas_build_stderr.log ]; then
            echo "----- eas build stderr (for debugging) -----"
            cat eas_build_stderr.log
            echo "----- end eas build stderr -----"
          fi

          # EAS CLI JSON shape can vary across versions; normalize to an array of build objects.
          ANDROID_BUILD_ID=$(node -e "const j=require('./builds.json'); const arr=Array.isArray(j)?j:(j?.data?.builds??j?.builds??j?.data??j?.build??[j]); const builds=Array.isArray(arr)?arr:[arr]; const b=builds.find(x=>x?.platform==='android') || builds.find(x=>x?.data?.platform==='android'); console.log((b?.id||b?.buildId||b?.data?.id||'').toString())")
          IOS_BUILD_ID=$(node -e "const j=require('./builds.json'); const arr=Array.isArray(j)?j:(j?.data?.builds??j?.builds??j?.data??j?.build??[j]); const builds=Array.isArray(arr)?arr:[arr]; const b=builds.find(x=>x?.platform==='ios') || builds.find(x=>x?.data?.platform==='ios'); console.log((b?.id||b?.buildId||b?.data?.id||'').toString())")
          if [ -z "$ANDROID_BUILD_ID" ] || [ -z "$IOS_BUILD_ID" ]; then
            echo "ERROR: could not extract build IDs from JSON"
            exit 2
          fi
          echo "android_build_id=$ANDROID_BUILD_ID" >> "$GITHUB_OUTPUT"
          echo "ios_build_id=$IOS_BUILD_ID" >> "$GITHUB_OUTPUT"

      - name: Download Android artifact
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts/android
          echo "Downloading build id: ${{ steps.builds.outputs.android_build_id }}"
          cd mobile
          eas build:view "${{ steps.builds.outputs.android_build_id }}" --json > ../android_build_view.json
          cd ..
          BUILD_URL=$(node -e "const j=require('./android_build_view.json'); const a=j?.artifacts||{}; console.log(a.buildUrl || a.applicationArchiveUrl || a.aabUrl || a.apkUrl || a.ipaUrl || '')")
          if [ -z "$BUILD_URL" ]; then
            echo "ERROR: could not find Android artifact URL in build:view JSON"
            exit 2
          fi
          EXT=$(node -e "const u=process.argv[1]||''; const m=u.match(/\\.([a-zA-Z0-9]+)(?:\\?|$)/); console.log(m?m[1]:'aab')" "$BUILD_URL")
          OUT="./artifacts/android/build-${{ steps.builds.outputs.android_build_id }}.${EXT}"
          echo "Downloading: $BUILD_URL"
          curl -fL --retry 5 --retry-delay 2 -o "$OUT" "$BUILD_URL"
          ls -la artifacts/android
          cp builds.json artifacts/android/builds.json
          cp android_build_view.json artifacts/android/android_build_view.json

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: artifacts/android

      - name: Download iOS artifact
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts/ios
          echo "Downloading build id: ${{ steps.builds.outputs.ios_build_id }}"
          cd mobile
          eas build:view "${{ steps.builds.outputs.ios_build_id }}" --json > ../ios_build_view.json
          cd ..
          BUILD_URL=$(node -e "const j=require('./ios_build_view.json'); const a=j?.artifacts||{}; console.log(a.buildUrl || a.applicationArchiveUrl || a.ipaUrl || '')")
          if [ -z "$BUILD_URL" ]; then
            echo "ERROR: could not find iOS artifact URL in build:view JSON"
            exit 2
          fi
          EXT=$(node -e "const u=process.argv[1]||''; const m=u.match(/\\.([a-zA-Z0-9]+)(?:\\?|$)/); console.log(m?m[1]:'ipa')" "$BUILD_URL")
          OUT="./artifacts/ios/build-${{ steps.builds.outputs.ios_build_id }}.${EXT}"
          echo "Downloading: $BUILD_URL"
          curl -fL --retry 5 --retry-delay 2 -o "$OUT" "$BUILD_URL"
          ls -la artifacts/ios
          cp builds.json artifacts/ios/builds.json
          cp ios_build_view.json artifacts/ios/ios_build_view.json

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-artifacts
          path: artifacts/ios

      - name: Upload EAS build stderr (if any)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: eas-build-stderr
          path: eas_build_stderr.log
          if-no-files-found: ignore

