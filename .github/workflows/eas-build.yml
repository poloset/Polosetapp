name: EAS Build (Android + iOS)

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: 18

jobs:
  prepare:
    name: Prepare cache keys
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: cache-key
        shell: bash
        run: |
          # Compose a cache key based on lockfile (falls back to package.json, then date)
          if [ -f package-lock.json ]; then
            KEY_HASH=$(sha256sum package-lock.json | cut -d' ' -f1)
          elif [ -f yarn.lock ]; then
            KEY_HASH=$(sha256sum yarn.lock | cut -d' ' -f1)
          elif [ -f pnpm-lock.yaml ]; then
            KEY_HASH=$(sha256sum pnpm-lock.yaml | cut -d' ' -f1)
          elif [ -f package.json ]; then
            KEY_HASH=$(sha256sum package.json | cut -d' ' -f1)
          else
            KEY_HASH=$(date +%Y%m%d)
          fi
          echo "key=node-${KEY_HASH}" >> "$GITHUB_OUTPUT"

  build-android:
    name: Build Android (EAS)
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache node modules and npm cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ needs.prepare.outputs.cache-key }}-npm-${{ runner.os }}
          restore-keys: |
            ${{ needs.prepare.outputs.cache-key }}-npm-

      - name: Restore Gradle cache
        uses: actions/cache@v4
        with:
          path: ~/.gradle/caches
          key: ${{ needs.prepare.outputs.cache-key }}-gradle-${{ runner.os }}
          restore-keys: |
            ${{ needs.prepare.outputs.cache-key }}-gradle-

      - name: Install dependencies
        run: npm ci

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Expo login (CI)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: eas login --token "$EXPO_TOKEN"

      # Optional: decode Android keystore if provided as secret ANDROID_KEYSTORE_BASE64
      - name: Decode Android keystore (optional)
        if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          mkdir -p ./keystore
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > ./keystore/keystore.jks
          ls -l ./keystore

      - name: Run EAS build (Android production)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          # non-interactive build
          eas build --platform android --profile production --non-interactive

      - name: List recent builds (Android)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas build:list --platform android --limit 5 > android_builds.txt || true
          cat android_builds.txt

      - name: Upload Android build list as artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-build-list
          path: android_builds.txt

  build-ios:
    name: Build iOS (EAS)
    runs-on: macos-latest
    needs: [prepare, build-android]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache node modules and npm cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ needs.prepare.outputs.cache-key }}-npm-${{ runner.os }}
          restore-keys: |
            ${{ needs.prepare.outputs.cache-key }}-npm-

      - name: Install dependencies
        run: npm ci

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Expo login (CI)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: eas login --token "$EXPO_TOKEN"

      # Optional: write Apple API Key json to disk if provided
      - name: Write Apple API Key JSON (optional)
        if: ${{ secrets.APPLE_API_KEY_JSON != '' }}
        env:
          APPLE_API_KEY_JSON: ${{ secrets.APPLE_API_KEY_JSON }}
        run: |
          echo "$APPLE_API_KEY_JSON" > ./apple_api_key.json
          ls -l ./apple_api_key.json

      - name: Run EAS build (iOS production)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas build --platform ios --profile production --non-interactive

      - name: List recent builds (iOS)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas build:list --platform ios --limit 5 > ios_builds.txt || true
          cat ios_builds.txt

      - name: Upload iOS build list as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-list
          path: ios_builds.txt

