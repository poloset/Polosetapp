name: EAS Build (Android + iOS) and download artifacts

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: 18

jobs:
  build:
    name: Build & download Android + iOS (EAS)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        working-directory: mobile
        run: bun install --frozen-lockfile

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Expo login (CI)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas login --token "$EXPO_TOKEN"

      - name: Run EAS build (Android + iOS production) and save JSON
        id: builds
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -e
          # Run builds and emit machine-readable JSON to file
          cd mobile
          eas build --platform all --profile production --non-interactive --json --wait > ../builds.json
          cd ..
          cat builds.json
          ANDROID_BUILD_ID=$(node -e "const j=require('./builds.json'); const arr=Array.isArray(j)?j:[j]; const b=arr.find(x=>x?.platform==='android') || arr.find(x=>x?.data?.platform==='android'); const v=b?.id||b?.buildId||b?.data?.id||''; console.log(v)")
          IOS_BUILD_ID=$(node -e "const j=require('./builds.json'); const arr=Array.isArray(j)?j:[j]; const b=arr.find(x=>x?.platform==='ios') || arr.find(x=>x?.data?.platform==='ios'); const v=b?.id||b?.buildId||b?.data?.id||''; console.log(v)")
          if [ -z "$ANDROID_BUILD_ID" ] || [ -z "$IOS_BUILD_ID" ]; then
            echo "ERROR: could not extract build IDs from JSON"
            exit 2
          fi
          echo "android_build_id=$ANDROID_BUILD_ID" >> "$GITHUB_OUTPUT"
          echo "ios_build_id=$IOS_BUILD_ID" >> "$GITHUB_OUTPUT"

      - name: Download Android artifact
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -e
          mkdir -p artifacts/android
          echo "Downloading build id: ${{ steps.builds.outputs.android_build_id }}"
          cd mobile
          eas build:view "${{ steps.builds.outputs.android_build_id }}" --json > ../android_build_view.json
          cd ..
          cat android_build_view.json
          BUILD_URL=$(node -e "const j=require('./android_build_view.json'); const a=j?.artifacts||{}; console.log(a.buildUrl || a.applicationArchiveUrl || a.aabUrl || a.apkUrl || a.ipaUrl || '')")
          if [ -z "$BUILD_URL" ]; then
            echo "ERROR: could not find Android artifact URL in build:view JSON"
            exit 2
          fi
          EXT=$(node -e "const u=process.argv[1]||''; const m=u.match(/\\.([a-zA-Z0-9]+)(?:\\?|$)/); console.log(m?m[1]:'aab')" "$BUILD_URL")
          OUT="./artifacts/android/build-${{ steps.builds.outputs.android_build_id }}.${EXT}"
          echo "Downloading: $BUILD_URL"
          curl -fL --retry 5 --retry-delay 2 -o "$OUT" "$BUILD_URL"
          ls -la artifacts/android
          cp builds.json artifacts/android/builds.json
          cp android_build_view.json artifacts/android/android_build_view.json

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: artifacts/android

      - name: Download iOS artifact
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -e
          mkdir -p artifacts/ios
          echo "Downloading build id: ${{ steps.builds.outputs.ios_build_id }}"
          cd mobile
          eas build:view "${{ steps.builds.outputs.ios_build_id }}" --json > ../ios_build_view.json
          cd ..
          cat ios_build_view.json
          BUILD_URL=$(node -e "const j=require('./ios_build_view.json'); const a=j?.artifacts||{}; console.log(a.buildUrl || a.applicationArchiveUrl || a.ipaUrl || '')")
          if [ -z "$BUILD_URL" ]; then
            echo "ERROR: could not find iOS artifact URL in build:view JSON"
            exit 2
          fi
          EXT=$(node -e "const u=process.argv[1]||''; const m=u.match(/\\.([a-zA-Z0-9]+)(?:\\?|$)/); console.log(m?m[1]:'ipa')" "$BUILD_URL")
          OUT="./artifacts/ios/build-${{ steps.builds.outputs.ios_build_id }}.${EXT}"
          echo "Downloading: $BUILD_URL"
          curl -fL --retry 5 --retry-delay 2 -o "$OUT" "$BUILD_URL"
          ls -la artifacts/ios
          cp builds.json artifacts/ios/builds.json
          cp ios_build_view.json artifacts/ios/ios_build_view.json

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-artifacts
          path: artifacts/ios

