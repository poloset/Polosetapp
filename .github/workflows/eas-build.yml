name: EAS Build (Android + iOS) and download artifacts

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: 18

jobs:
  build-android:
    name: Build & download Android (EAS)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Expo login (CI)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas login --token "$EXPO_TOKEN"

      - name: Run EAS build (Android production) and save JSON
        id: android_build
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -e
          # Run build and emit machine-readable JSON to file
          eas build --platform android --profile production --non-interactive --json > android_build.json
          cat android_build.json
          # Extract build id using node (portable)
          BUILD_ID=$(node -e "const j=require('./android_build.json'); console.log(j.id || j.buildId || (j.data && j.data.id) || '')")
          if [ -z "$BUILD_ID" ]; then
            echo "ERROR: could not extract Android build id from JSON"
            exit 2
          fi
          echo "android_build_id=$BUILD_ID" >> "$GITHUB_OUTPUT"

      - name: Download Android artifact
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -e
          mkdir -p artifacts/android
          echo "Downloading build id: ${{ steps.android_build.outputs.android_build_id }}"
          eas build:download --platform android --id "${{ steps.android_build.outputs.android_build_id }}" --output ./artifacts/android || true
          ls -la artifacts/android || true

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: artifacts/android

  build-ios:
    name: Build & download iOS (EAS)
    runs-on: macos-latest
    needs: build-android
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Expo login (CI)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas login --token "$EXPO_TOKEN"

      # Optional: write Apple API Key JSON to file if provided (for non-interactive credential use)
      - name: Write Apple API Key JSON (optional)
        if: ${{ secrets. 0QRKHMVYGSSV!= '' }}
        env:
          APPLE_API_KEY_JSON: ${{ secrets.APPLE_API_KEY_JSON }}
        run: |
          echo "$APPLE_API_KEY_JSON" > ./apple_api_key.json
          ls -l ./apple_api_key.json

      - name: Run EAS build (iOS production) and save JSON
        id: ios_build
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -e
          eas build --platform ios --profile production --non-interactive --json > ios_build.json
          cat ios_build.json
          BUILD_ID=$(node -e "const j=require('./ios_build.json'); console.log(j.id || j.buildId || (j.data && j.data.id) || '')")
          if [ -z "$BUILD_ID" ]; then
            echo "ERROR: could not extract iOS build id from JSON"
            exit 2
          fi
          echo "ios_build_id=$BUILD_ID" >> "$GITHUB_OUTPUT"

      - name: Download iOS artifact
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -e
          mkdir -p artifacts/ios
          echo "Downloading build id: ${{ steps.ios_build.outputs.ios_build_id }}"
          eas build:download --platform ios --id "${{ steps.ios_build.outputs.ios_build_id }}" --output ./artifacts/ios || true
          ls -la artifacts/ios || true

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-artifacts
          path: artifacts/ios

